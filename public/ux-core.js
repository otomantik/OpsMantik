"use strict";(()=>{var a={apiUrl:typeof window<"u"?window.location.origin+"/api/sync":"",sessionKey:"opmantik_session_sid",fingerprintKey:"opmantik_session_fp",contextKey:"opmantik_session_context",sessionStartKey:"opmantik_session_start",heartbeatInterval:6e4,sessionTimeout:18e5};function _(){let e=document.currentScript||document.querySelector("script[data-ops-site-id], script[data-site-id]"),t=e&&(e.getAttribute("data-ops-site-id")||e.getAttribute("data-site-id"))||"";if(!t&&typeof window<"u"&&window.opmantikConfig&&window.opmantikConfig.siteId&&(t=String(window.opmantikConfig.siteId)),!t){let n=document.getElementsByTagName("script");for(let o=0;o<n.length;o++){let i=n[o],s=(i.src||"").toLowerCase();if((s.indexOf("core.js")!==-1||s.indexOf("ux-core.js")!==-1)&&(i.getAttribute("data-ops-site-id")||i.getAttribute("data-site-id"))){t=i.getAttribute("data-ops-site-id")||i.getAttribute("data-site-id")||"";break}}}return t}function T(){let e=document.createElement("canvas"),t=e.getContext("2d");t.textBaseline="top",t.font="14px Arial",t.fillText("Fingerprint",2,2);let n=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),e.toDataURL()].join("|"),o=0;for(let i=0;i<n.length;i++){let s=n.charCodeAt(i);o=(o<<5)-o+s,o=o&o}return Math.abs(o).toString(36)}function g(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function P(){return Math.random().toString(36).slice(2,6).padEnd(4,"0")}function L(e){let t=(e||"").toString(),n=0;for(let i=0;i<t.length;i++)n=(n<<5)-n+t.charCodeAt(i),n|=0;return Math.abs(n).toString(36).slice(0,6).padEnd(6,"0")}function b(e,t){let n=Date.now(),o=L((t||"").toString().toLowerCase());return`${n}-${P()}-${e}-${o}`}function O(){let e={};try{navigator.language&&(e.lan=navigator.language)}catch{}try{typeof navigator.deviceMemory=="number"&&(e.mem=navigator.deviceMemory)}catch{}try{typeof navigator.hardwareConcurrency=="number"&&(e.con=navigator.hardwareConcurrency)}catch{}try{typeof screen<"u"&&(e.sw=screen.width,e.sh=screen.height)}catch{}try{typeof window.devicePixelRatio=="number"&&(e.dpr=window.devicePixelRatio)}catch{}try{let t=document.createElement("canvas"),n=t.getContext("webgl")||t.getContext("experimental-webgl");if(n){let o=n.getExtension("WEBGL_debug_renderer_info");if(o){let i=n.getParameter(o.UNMASKED_RENDERER_WEBGL);i&&(e.gpu=i)}}}catch{}try{let t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;t&&t.effectiveType&&(e.con_type=t.effectiveType)}catch{}return e}function y(){let e=sessionStorage.getItem(a.sessionKey),t=localStorage.getItem(a.fingerprintKey),n=sessionStorage.getItem(a.contextKey);t||(t=T(),localStorage.setItem(a.fingerprintKey,t)),e&&!/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)&&(e=null,sessionStorage.removeItem(a.sessionKey)),e?sessionStorage.getItem(a.sessionStartKey)||sessionStorage.setItem(a.sessionStartKey,Date.now().toString()):(e=g(),sessionStorage.setItem(a.sessionKey,e),sessionStorage.setItem(a.sessionStartKey,Date.now().toString()));let s=new URLSearchParams(window.location.search).get("gclid")||n;return s&&(sessionStorage.setItem(a.contextKey,s),n=s),{sessionId:e,fingerprint:t,context:n}}var C="opsmantik_outbox_v2",m=!1;function A(){try{return JSON.parse(localStorage.getItem(C)||"[]")}catch{return[]}}function v(e){try{localStorage.setItem(C,JSON.stringify(e))}catch{}}async function l(){if(m)return;let e=A();if(e.length===0)return;m=!0;let t=e[0];try{if(t.attempts>10&&Date.now()-t.ts>864e5){e.shift(),v(e),m=!1,l();return}let n=new AbortController,o=setTimeout(()=>n.abort(),5e3),i=await fetch(a.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload),keepalive:!0,signal:n.signal});if(clearTimeout(o),i.ok)e.shift(),v(e),m=!1,l();else throw new Error("Server status: "+i.status)}catch{t.attempts++,v(e),m=!1,setTimeout(l,5e3)}}function D(e){let t=A(),o={id:typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():g(),ts:Date.now(),payload:e,attempts:0};t.push(o),t.length>100&&t.splice(0,t.length-80),v(t),l()}function M(){let e=A();e.length>0&&navigator.sendBeacon&&navigator.sendBeacon(a.apiUrl,new Blob([JSON.stringify(e[0].payload)],{type:"application/json"}))}var r={maxScroll:0,ctaHovers:0,focusDur:0,activeSec:0,lastActiveAt:typeof Date<"u"?Date.now():0};function U(){let e={};r.maxScroll>0&&(e.scroll_pct=Math.min(100,r.maxScroll)),r.ctaHovers>0&&(e.cta_hovers=r.ctaHovers),r.focusDur>0&&(e.focus_dur=r.focusDur),r.activeSec>0&&(e.active_sec=r.activeSec);let t=0;try{t=parseInt(sessionStorage.getItem(a.sessionStartKey)||"0",10)}catch{}return t>0&&(e.duration_sec=Math.round((Date.now()-t)/1e3)),e}var p=_();p?console.log("[OPSMANTIK] \u2705 Tracker initializing for site:",p):console.warn("[OPSMANTIK] \u274C Site ID not found");function d(e,t,n,o,i={}){if(!p)return;let s=y(),f=window.location.href,h=document.referrer||"",w=new Date().toISOString().slice(0,7)+"-01",c={fp:s.fingerprint,gclid:s.context},S=O();Object.assign(c,S);let u=document.currentScript||document.querySelector("script[data-ops-site-id]");if(u){let x=u.getAttribute("data-geo-city"),E=u.getAttribute("data-geo-district");x&&(c.city=x),E&&(c.district=E)}(e==="conversion"||t==="heartbeat"||t==="session_end")&&(t==="heartbeat"&&(r.activeSec+=Math.round((Date.now()-r.lastActiveAt)/1e3),r.lastActiveAt=Date.now()),Object.assign(c,U())),Object.assign(c,i);let I={s:p,u:f,sid:s.sessionId,sm:w,ec:e,ea:t,el:n,ev:o,r:h,meta:c};D(I)}function k(e){if(!p)return;let t=y(),n=window.location.origin+"/api/call-event",o=document.currentScript||document.querySelector("script[data-ops-site-id]"),i=o?.getAttribute("data-ops-proxy-url")||window.opmantikConfig?.opsProxyUrl||"",s=g(),f=JSON.stringify({event_id:s,site_id:p,phone_number:e,fingerprint:t.fingerprint,action:typeof e=="string"&&(e.indexOf("wa.me")!==-1||e.indexOf("whatsapp")!==-1)?"whatsapp":"phone",url:window.location.href,ua:navigator.userAgent});if(i){fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:f,keepalive:!0}).catch(()=>{});return}let h=o?.getAttribute("data-ops-secret")||window.opmantikConfig?.opsSecret||"";if(h&&window.crypto?.subtle){let w=Math.floor(Date.now()/1e3),c=new TextEncoder,S=w+"."+f;window.crypto.subtle.importKey("raw",c.encode(h),{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then(u=>window.crypto.subtle.sign("HMAC",u,c.encode(S))).then(u=>{let I=Array.from(new Uint8Array(u)).map(x=>x.toString(16).padStart(2,"0")).join("");return fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-Ops-Site-Id":p,"X-Ops-Ts":String(w),"X-Ops-Signature":I},body:f,keepalive:!0})}).catch(()=>{});return}fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:f,keepalive:!0}).catch(()=>{})}function K(){console.log("[OPSMANTIK] Auto-tracking initialized"),d("interaction","view",document.title),document.addEventListener("click",t=>{let n=t.target.closest('a[href^="tel:"]');if(n){let i=b("tel",n.href);d("conversion","phone_call",n.href,null,{intent_stamp:i,intent_action:"phone_call"}),k(n.href);return}let o=t.target.closest('a[href*="wa.me"], a[href*="whatsapp.com"]');if(o){let i=b("wa",o.href);d("conversion","whatsapp",o.href,null,{intent_stamp:i,intent_action:"whatsapp"}),k(o.href)}}),document.addEventListener("submit",t=>{t.target.tagName==="FORM"&&d("conversion","form_submit",t.target.id||t.target.name||"form")}),window.addEventListener("scroll",()=>{let t=document.documentElement,n=Math.round((window.scrollY+window.innerHeight)/t.scrollHeight*100);n>r.maxScroll&&(r.maxScroll=n,n>=50&&n<90?d("interaction","scroll_depth","50%",n):n>=90&&d("interaction","scroll_depth","90%",n))}),document.addEventListener("mouseenter",t=>{t.target.closest&&t.target.closest('a[href^="tel:"], a[href*="wa.me"], a[href*="whatsapp.com"], [data-om-cta="true"]')&&r.ctaHovers++},!0);let e=0;document.addEventListener("focusin",t=>{t.target&&/INPUT|TEXTAREA|SELECT/.test(t.target.tagName)&&(e=Date.now())}),document.addEventListener("focusout",t=>{e>0&&t.target&&/INPUT|TEXTAREA|SELECT/.test(t.target.tagName)&&(r.focusDur+=Math.round((Date.now()-e)/1e3),e=0)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?r.activeSec+=Math.round((Date.now()-r.lastActiveAt)/1e3):r.lastActiveAt=Date.now()}),setInterval(()=>d("system","heartbeat","session_active"),a.heartbeatInterval),window.addEventListener("beforeunload",()=>{r.activeSec+=Math.round((Date.now()-r.lastActiveAt)/1e3),d("system","session_end","page_unload",null,{exit_page:window.location.href}),M()})}typeof window<"u"&&(window.opmantik={send:d,session:y,_initialized:!0},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{l(),K()}):(l(),K()),window.addEventListener("online",l));})();
